<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-selectable.html">

<!--
`swipe-vpages`
container element based on iron pages to support vertical swipe 

@demo demo/index.html 
-->

<dom-module id="swipe-vpages">
    <template>
        <style>
            :host {
                display: block;
                overflow: hidden;
                position: relative;
                height: 100%;
            }
            
            :host >::content > * {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                height: 100%;
                right: 0;
                transform:none;
            }
            
            :host >::content >:not(.iron-selected):not(.swipe-next):not(.swipe-up):not(.swipe-down) {
                display: none !important;
            }
            
            :host >::content > .swipe-up {
                pointer-events: none; 
            }
            
            :host >::content > .swipe-down {
                pointer-events: none; 
            }
            
/*
            :host >::content > .swipe-restore {
                pointer-events: none;
            }
*/
            
            :host >::content > .swipe-next {
                pointer-events: none; 
            }

        </style>

        <content id="content"></content>
    </template>

</dom-module>

<script>
    (function() {

        Polymer({

            is: 'swipe-vpages',

            behaviors: [
                Polymer.IronResizableBehavior,
                Polymer.IronSelectableBehavior
            ],

            properties: {

                transitionTimingFunction: {
                    type: String,
                    //value: 'cubic-bezier(0.4, 0.0, 0.2, 1)'
                    //value: 'ease-in-out'
                    value : 'ease-in-out'
                },
                transitionDuration: {
                    type: Number,
                    value: 2000
                },
                nextItem: {
                    type: Object,
                    observer: 'onNextItemChange'
                },
                pages : {
                    type : Array,
                    value : []
                }
            },
            ready: function(e) {
                this.zIndex = 0;
                this._swipeUp = true;
                this.pos = -1;
            },
            attached: function(e) {
                this.zIndex = Number(this.getComputedStyleValue('z-index'));
                this.select(0);
                var rect = this.getBoundingClientRect();
                this.height = rect.bottom - rect.top;
            },
            listeners: {
                'iron-select': '_onIronSelect',
                'track': '_onTrack',
                'tap': '_onTap',
                'transitionend' : '_onTransitionEnd'
            },
//            observers : [
//                'pagesChanged(pages.splices)'    
//            ],
            _onTransitionEnd : function(e) {
                var page = e.target;
                console.log('_onTransitionEnd ', page.id);
                var idx = this.pages.indexOf(page);
                if (idx > -1) {
                    this.splice('pages', idx, 1);
                }
                page.style.transitionDuration = "0ms";
                page.style.transform= "none";
                page.classList.remove('swipe-up');
                page.classList.remove('swipe-down');
                page.classList.remove('swipe-pause');
                page.style.zIndex = this.zIndex - 1;
                this.setlayers();
            },
            setlayers : function() {
                var self = this;
                this.pages.forEach(function(page, idx) {
                    page.style.zIndex = self.zIndex + idx + 1;
                });
                this.selectedItem.style.zIndex = this.zIndex;
            },
            doTransitions :  function() {
                var self = this;
                var idx = this.pages.indexOf(self.selectedItem);
                if (idx > -1) {
                    this.splice('pages', idx, 1);
                }
                this.pages.forEach(function(page, idx) {
                    var rect = self.selectedItem.getBoundingClientRect();
                    page.style.transitionTimingFunction = self.transitionTimingFunction;
                    page.style.top = 0;
                    page.style.transitionDuration = Number(self.transitionDuration) + "ms";
                    var tr;
                    if (self.swipeDirection === 'up') { 
                        tr = "translateY(" + String(-self.height) + "px)";
                    } else if (self.swipeDirection === 'down'){
                        tr = "translateY(" +  String(self.height) + "px)";
                    } else {
                       tr = "translateY(0px)";
                    }
                    console.log('page ', page.id, tr);
                    page.style.transform = tr;
                });
                console.log('selected restore ', this.selectedItem.id);
                var page = self.selectedItem;
                if (page) {
                    page.classList.remove('swipe-down');
                    page.classList.remove('swipe-up');
                    page.classList.remove('swipe-pause');
                    page.classList.remove('swipe-next');
                    var rect = self.selectedItem.getBoundingClientRect();
                    page.style.transitionTimingFunction = self.transitionTimingFunction;
                    page.style.transitionDuration = Number(self.transitionDuration) + "ms";
                    page.style.top = 0;
                    page.style.transform = "translateY(" + String(0) + "px)";
                }
            },
            cancelTransition : function(e) {
                console.log('cancelTransition');
            },
            _onTap: function(e) {
                console.log('_onTap ', e.currentTarget.id, e.target);
            },
            getZIndex : function(el){
                return window.getComputedStyle(el, null).getPropertyValue('z-index');
            },
            _onTrack: function(e) {

                console.log('_onTrack ', e.detail.state, e.target.id, e.detail.dy, e.detail.ddy);
        
                var page = e.target;
                // TODO if already moving 
                var rect = page.getBoundingClientRect();
                var pos = this.items.indexOf(page);
                if (pos < 0) {
                    return;
                }
                
                
                switch (e.detail.state) {
                    case 'start':
                        this._lastddy = 0;
                        break;

                    case 'track':
                       
                        if (e.detail.dy < 0) {
                            this._swipeUp = true;
                            if (pos < this.items.length - 1) {
                                this.items[pos+1].classList.add('swipe-next');
                            }
                            if (pos > 0) {
                                this.items[pos-1].classList.remove('swipe-next');
                            }
                        } else if (e.detail.dy > 0) {
                            this._swipeUp = false;
                            if (pos < this.items.length - 1) {
                                this.items[pos+1].classList.remove('swipe-next');
                            }
                            if (pos > 0) {
                                this.items[pos-1].classList.add('swipe-next');
                            }
                        }
                        this.setlayers();
                        
                        this._lastddy = e.detail.ddy;
                        var rect = page.getBoundingClientRect();
                        
                        page.style.transitionDuration = "0ms";
                        page.style.transform = "translateY(" + String(e.detail.dy) + "px)";
                        page.style.transitionTimingFunction = this.transitionTimingFunction;
                        
                        //page.style.top = rect.top + e.detail.ddy + "px";
                        
                        break;

                    case 'end':
                        
                        page.style.top = 0;
                        if (this._lastddy > -1 && this._lastddy < 1) {
                            
                        } else if (this._lastddy < 0)  {
                            if (this.pos < this.items.length - 1) {
                                this.swipeDirection = 'up';
                                this.addPage(page);
                                page.classList.add('swipe-up');
                                this.selectNext();
                            } 
                        }
                        else if (this._lastddy > 0) {
                            if (this.pos > 0) {
                                if (page === this.selectedItem) {
                                    this.addPage(page);
                                    this.selectPrevious();
                                    this.swipeDirection = 'down';
                                    page.classList.add('swipe-down');
                                    this.addPage(page);
                                }
                            } 
                        }
                        this.setlayers();
                        this.doTransitions();
                        e.preventDefault();
                       
                        break;
                }
            },
            addPage : function(page) {
                if (this.pages.indexOf(page) > -1) {
                    return;
                }
                var startPos = -1;
                var pos = this.items.indexOf(page) || 0;
                if (this.pages.length === 0) {
                    startPos = this.items.indexOf(this.pages[0]);
                }
                if (pos < startPos) {
                    this.pages.unshift(page);
                } else {
                    this.pages.push(page);
                }
            },
            _onIronSelect: function(event) {
                if (this.pos > -1) {
                    if (this.pos < this.items.length - 1) {
                        this.items[this.pos+1].classList.remove('swipe-next');
                    }
                    if (this.pos > 0) {
                        this.items[this.pos-1].classList.remove('swipe-next');
                    }
                }
                
                var page = event.detail.item;
                var pos = this.items.indexOf(page);
                if (pos < 0) {
                    return;
                }
                
                this.pos = pos;
                this.setlayers();
            }
        });

    })();

</script>
